<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Click‚ÄôHeure ‚Äî Leew11</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0f2a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Click‚ÄôHeure">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --txt:#e9efff;--mut:#a9b5ff;--gold:#ffd978;--gem:#7af2ff;--bg1:#0b0f2a;--bg2:#080b1e;
  --hp:#ff6a6a;--hp2:#ffa86a;--php:#8affdf;--php2:#b6ffe9;
  --navH:150px; --headH:60px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;color:var(--txt);
  font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));
  -webkit-tap-highlight-color:transparent}
@supports(height:100svh){ body{min-height:100svh}}
body{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);overscroll-behavior:none}

.wrap{max-width:1100px;margin:0 auto}

/* Header collant */
header{position:sticky;top:0;z-index:40;height:var(--headH);display:flex;align-items:center;
  backdrop-filter:blur(10px);background:linear-gradient(180deg,rgba(12,18,45,.85),rgba(7,10,24,.7));
  border-bottom:1px solid rgba(255,255,255,.08)}
.head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;width:100%}
.pill{display:inline-flex;align-items:center;gap:6px;padding:.4rem .6rem;border-radius:999px;
  background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.12);color:var(--mut);font-weight:800}
.pill b{color:var(--txt)}

/* === FIX MOBILE : viewport plein √©cran, onglets scrollables === */
main{
  padding: 8px 10px calc(var(--navH) + 12px);
  height: calc(100svh - var(--headH));
  overflow: hidden;
}
.tabs, .tab { height: 100%; }
.tab{
  display: none;
  overflow: hidden;
}
.tab.active{
  display: flex;
  flex-direction: column;
}
.tabBody{
  flex: 1 1 auto;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: calc(var(--navH) + 16px);
}

/* Cartes / listes */
.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.35);
  margin-top:10px}
.sectionTitle{display:flex;gap:10px;padding:10px 12px;margin:0;font-weight:900}
.sectionTitle.gold{color:#ffe48a}.sectionTitle.gem{color:#9bf1ff}.sectionTitle.star{color:#ffe27a}

/* Sc√®ne combat + fond anim√© (parallaxe douce) */
.stage{position:relative;height:100%;border-radius:16px;overflow:hidden}
.bg{position:absolute;inset:0;pointer-events:none;z-index:0;opacity:.9}
.bg .layer{position:absolute;inset:0;background-size:cover;background-position:center;opacity:.28;animation:pan 26s linear infinite}
.bg .layer.front{opacity:.42;animation-duration:18s}
@keyframes pan{from{background-position:0% 50%}to{background-position:100% 50%}}

.enemyWrap{
  height:48vh; min-height:260px;
  display:flex; align-items:center; justify-content:center; position:relative; z-index:2
}
#enemyImg{
  display:block;
  max-width:92%; max-height:44vh; object-fit:contain;
  width:auto; height:auto;
  border-radius:14px;
  background:radial-gradient(circle at 50% 45%, rgba(255,255,255,.08), rgba(255,255,255,0));
  filter:drop-shadow(0 16px 34px rgba(0,0,0,.45));
  animation:float 3.2s ease-in-out infinite
}
@keyframes float{50%{transform:translateY(-4px) scale(1.02)}}
.hit{animation:shake .18s ease}
@keyframes shake{25%{transform:translateX(-3px)}50%{transform:translateX(3px)}75%{transform:translateX(-2px)}}

/* Barres */
.bar{position:relative;height:20px;background:#131a42;border:1px solid rgba(255,255,255,.12);
  border-radius:10px;overflow:hidden;margin:10px 14px}
.fill{position:absolute;left:0;top:0;height:100%;width:100%;
  background:linear-gradient(90deg,var(--hp),var(--hp2));transition:width .25s}
.hpP .fill{background:linear-gradient(90deg,var(--php),var(--php2))}
.row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.small{opacity:.9;color:var(--mut);padding:0 14px 10px}

/* Boutons */
.btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:900;color:#0a0f1e;cursor:pointer;
  background:linear-gradient(180deg,#fff,#eef1ff);box-shadow:0 12px 26px rgba(0,0,0,.35), inset 0 -6px 12px rgba(100,100,255,.1)}
.btn.gold{background:linear-gradient(180deg,#fff3c6,#ffe48a)}.btn.gem{background:linear-gradient(180deg,#e6fbff,#b8f2ff)}
.btn.star{background:linear-gradient(180deg,#fff6cc,#ffe27a)}
.btn:active{transform:translateY(1px)}
.actions{display:flex;gap:10px;padding:12px;flex-wrap:wrap}

/* Nav 2 lignes en bas */
nav{position:fixed;left:0;right:0;bottom:0;z-index:30;height:var(--navH);
  background:linear-gradient(180deg,rgba(8,10,24,.2),rgba(6,9,21,.9));
  backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,.08)}
.navInner{display:grid;grid-template-columns:repeat(3,1fr);grid-auto-rows:minmax(44px,auto);gap:8px;padding:10px 12px;height:100%}
.navInner button{padding:.7rem;border-radius:12px;border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.06);color:var(--txt);font-weight:900}
.navInner button.active{background:#fff;color:#0a0f1e}

/* Shops */
.shopGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:10px}
.item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
  background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}
.item.gold{border-color:#ffe48a55}.item.gem{border-color:#9bf1ff55}.item.star{border-color:#ffe27a55}
.ico{min-width:46px;min-height:46px;border-radius:12px;display:grid;place-items:center;background:radial-gradient(circle at 30% 30%, #fff, #e9efff)}
.heroPic{width:56px;height:56px;border-radius:12px;object-fit:cover;border:1px solid rgba(255,255,255,.18)}

/* Effets */
.float{position:fixed;pointer-events:none;font-weight:900;font-size:16px;text-shadow:0 2px 0 rgba(0,0,0,.5);
  animation:pop .9s ease-out forwards;z-index:999}
@keyframes pop{to{opacity:0;transform:translateY(-44px) scale(.96)}}
.version{position:fixed;right:8px;bottom:8px;opacity:.85;font-weight:800;background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.18);padding:.2rem .5rem;border-radius:10px;z-index:60}

/* √âp√©iste illustr√© (compact) */
#swordsman{position:absolute;left:6px;bottom:10px;z-index:3;display:block;pointer-events:none;transform:scale(.9)}
.s-man{position:relative;width:70px;height:80px}
.s-head{position:absolute;left:26px;top:0;width:18px;height:18px;border-radius:50%;
  background:radial-gradient(circle at 30% 30%,#ffe9c6,#eec9a8)}
.s-helm{position:absolute;left:22px;top:-4px;width:26px;height:16px;border-radius:8px 8px 4px 4px;
  background:linear-gradient(180deg,#b6c8ff,#6a8aff);border:1px solid rgba(255,255,255,.35)}
.s-body{position:absolute;left:18px;top:16px;width:34px;height:40px;border-radius:10px;
  background:linear-gradient(180deg,#7aa1ff,#3a5aff);border:1px solid rgba(255,255,255,.25)}
.s-cape{position:absolute;left:4px;top:14px;width:24px;height:46px;border-radius:10px 0 0 10px;opacity:.9;
  background:linear-gradient(180deg,#ff556e,#c02a44);filter:drop-shadow(0 8px 12px rgba(0,0,0,.25));
  animation:cape 2.2s ease-in-out infinite}
@keyframes cape{50%{transform:skewX(-6deg) translateX(-2px)}}
.s-legL,.s-legR{position:absolute;bottom:0;width:10px;height:22px;border-radius:4px;
  background:linear-gradient(180deg,#2b3a6e,#16224a)}
.s-legL{left:22px;animation:stepL 1s ease-in-out infinite}
.s-legR{left:38px;animation:stepR 1s ease-in-out infinite}
@keyframes stepL{50%{transform:translateY(2px)}}@keyframes stepR{0%,100%{transform:translateY(2px)}50%{transform:translateY(0)}}
.s-sword{position:absolute;left:50px;top:6px;width:8px;height:44px;border-radius:4px;background:linear-gradient(180deg,#fff,#dfe8ff);
  transform-origin:10% 0;box-shadow:0 10px 20px rgba(0,0,0,.35)}
.swing .s-sword{animation:swing .25s cubic-bezier(.2,.8,.2,1)}
@keyframes swing{0%{transform:rotate(0)}70%{transform:rotate(-80deg) translate(-2px,6px)}100%{transform:rotate(-88deg) translate(-4px,8px)}}
</style>
</head>
<body>

<header>
  <div class="wrap head">
    <strong>Click‚ÄôHeure ‚Äî <span style="opacity:.8">Leew11</span></strong>
    <div class="pill">üåä Vague <b id="waveTop">1</b></div>
    <div class="pill">‚õÉ <b id="gold">0</b></div>
    <div class="pill">üíé <b id="gems">0</b></div>
    <div class="pill">‚≠ê <b id="stars">0</b></div>
  </div>
</header>

<main class="wrap">
  <section class="tabs">

    <!-- COMBAT -->
    <div class="tab active" data-tab="combat">
      <div class="tabBody">
        <div class="card stage" id="enemyArea">
          <!-- Fond anim√© -->
          <div class="bg" id="biomeBg">
            <div class="layer back"></div>
            <div class="layer front"></div>
          </div>

          <!-- √âp√©iste -->
          <div id="swordsman"><div class="s-man">
            <div class="s-cape"></div><div class="s-helm"></div><div class="s-head"></div>
            <div class="s-body"></div><div class="s-legL"></div><div class="s-legR"></div>
            <div class="s-sword"></div>
          </div></div>

          <div class="row" style="justify-content:space-between;padding:10px 14px">
            <span class="pill">Vague <b id="wave">1</b> <span id="bossTag"></span></span>
            <span class="pill">Ennemi: <b id="enemyName">‚Äî</b></span>
            <span class="pill">Butin: <b id="reward">+0</b></span>
          </div>
          <div class="bar"><div class="fill" id="hpFill"></div></div>
          <div class="enemyWrap" id="hitZone"><img id="enemyImg" alt="ennemi"></div>
          <div class="bar hpP"><div class="fill" id="phpFill"></div></div>
          <div class="row small">
            <span>PV Ennemi <b id="hpNow">0</b>/<b id="hpMax">0</b></span>
            <span>PV Joueur <b id="phpNow">0</b>/<b id="phpMax">0</b></span>
            <span class="pill">üñ± <b id="gpc">1</b></span>
            <span class="pill">‚öîÔ∏è <b id="dps">0</b></span>
            <span class="pill">‚≠ê Crit% <b id="critRate">0</b></span>
            <span class="pill">‚≠ê Crit√ó <b id="critMult">1.5</b></span>
            <span class="pill">üõ°Ô∏è Esquive <b id="dodge">5</b>%</span>
            <span class="pill">‚ûï Regen <b id="regen">1.0</b>/s</span>
          </div>
          <div class="row actions">
            <button class="btn gold" id="hitBtn">‚öîÔ∏è Attaquer</button>
            <button class="btn" id="installBtn" style="display:none">üì≤ Installer l‚Äôapp</button>
            <button class="btn" id="saveBtn">üíæ Sauver</button>
            <button class="btn" id="resetBtn">üîÑ Ascension</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SHOP OR -->
    <div class="tab" data-tab="shop">
      <div class="tabBody">
        <div class="card">
          <h3 class="sectionTitle gold">‚õÉ Boutique Or</h3>
          <div class="row" style="gap:8px;padding:8px 12px">
            <span class="pill">Quantit√©</span>
            <button data-q="1" class="btn gold" style="padding:.35rem .6rem">x1</button>
            <button data-q="10" class="btn gold" style="padding:.35rem .6rem">x10</button>
            <button data-q="100" class="btn gold" style="padding:.35rem .6rem">x100</button>
          </div>
          <div class="shopGrid" id="clickShop"></div>
          <div class="shopGrid" id="autoShop"></div>
          <div class="shopGrid" id="dodgeShop"></div>
          <div class="shopGrid" id="soldierShop"></div>
        </div>
      </div>
    </div>

    <!-- SHOP GEM -->
    <div class="tab" data-tab="gem">
      <div class="tabBody">
        <div class="card">
          <h3 class="sectionTitle gem">üíé H√©ros (Gem)</h3>
          <div class="shopGrid" id="gemShop"></div>
          <h3 class="sectionTitle gem">üíé Am√©liorations (Gem)</h3>
          <div class="shopGrid" id="gemUpgShop"></div>
        </div>
      </div>
    </div>

    <!-- SHOP ETOILES -->
    <div class="tab" data-tab="star">
      <div class="tabBody">
        <div class="card">
          <h3 class="sectionTitle star">‚≠ê Shop 2 ‚Äî Ascension</h3>
          <p class="small">Les √©toiles sont gagn√©es quand ta vie tombe √† 0 (reset). Les <b>gemmes et h√©ros (gem)</b> sont conserv√©s.</p>
          <div class="shopGrid" id="prestigeShop"></div>
        </div>
      </div>
    </div>

    <!-- DONJON -->
    <div class="tab" data-tab="dungeon">
      <div class="tabBody">
        <div class="card">
          <h3 class="sectionTitle">üè∞ Donjons (XP h√©ros)</h3>
          <div class="shopGrid" id="dungeonGrid"></div>
        </div>
      </div>
    </div>

    <!-- QU√äTES -->
    <div class="tab" data-tab="quests">
      <div class="tabBody">
        <div class="card">
          <h3 class="sectionTitle">üìú Qu√™tes (gemmes)</h3>
          <div class="shopGrid" id="questGrid"></div>
        </div>
      </div>
    </div>

  </section>
</main>

<nav>
  <div class="wrap navInner">
    <button class="active" data-goto="combat">‚öîÔ∏è Combat</button>
    <button data-goto="shop">üõí Or</button>
    <button data-goto="gem">üíé Gem</button>
    <button data-goto="star">‚≠ê √âtoiles</button>
    <button data-goto="dungeon">üè∞ Donjon</button>
    <button data-goto="quests">üìú Qu√™tes</button>
  </div>
</nav>

<div class="version">Click‚ÄôHeure ‚Äî mobile fixed</div>

<script>
(()=>{ // ====== UTIL & √âTAT ======
const $=id=>document.getElementById(id), fmt=n=>Math.floor(n).toLocaleString(), R=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const biomeBg=$("biomeBg"), enemyImg=$("enemyImg"), enemyNameEl=$("enemyName");
const hpFill=$("hpFill"),phpFill=$("phpFill");
const goldEl=$("gold"), gemsEl=$("gems"), starsEl=$("stars");

let gold=0,gems=0,stars=0,wave=1,buyQty=1,totalClicks=0,totalKills=0;
let gpc=1,dps=0,autoClicks=0,atkBase=1,critRate=0,critMult=1.5,dodgePct=5,regenPerSec=1;
let phpMax=100,phpNow=100,hpMax=160,hpNow=160;

/* Ennemis ‚Äî PNG Wikimedia */
const ENEMY_LIST = [
  { name: "Orc",     img: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/50/Orc_head_icon.png/320px-Orc_head_icon.png" },
  { name: "Gobelin", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/7/78/Goblin_head_icon.png/320px-Goblin_head_icon.png" },
  { name: "D√©mon",   img: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/2c/Demon_head_icon.png/320px-Demon_head_icon.png" },
  { name: "Dragon",  img: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/11/Dragon_head_icon.png/320px-Dragon_head_icon.png" }
];
const BOSS_LIST = [
  { name: "Seigneur Orc",    img: ENEMY_LIST[0].img },
  { name: "Roi Gobelin",     img: ENEMY_LIST[1].img },
  { name: "Seigneur D√©mon",  img: ENEMY_LIST[2].img },
  { name: "Dragon Ancien",   img: ENEMY_LIST[3].img }
];

/* Fond anim√© */
function applyBiome(){
  const idx=Math.floor((wave-1)/10)%3;
  const back = biomeBg.querySelector('.back');
  const front = biomeBg.querySelector('.front');
  if(idx===0){
    back.style.backgroundImage  ="url('https://images.unsplash.com/photo-1470770903676-69b98201ea1c?auto=format&fit=crop&w=1400&q=60')";
    front.style.backgroundImage ="url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1400&q=60')";
  }else if(idx===1){
    back.style.backgroundImage  ="url('https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1400&q=60')";
    front.style.backgroundImage ="url('https://images.unsplash.com/photo-1671726203436-2f0ae8f71b77?auto=format&fit=crop&w=1400&q=60')";
  }else{
    back.style.backgroundImage  ="url('https://images.unsplash.com/photo-1499696010180-025ef6e1a8f9?auto=format&fit=crop&w=1400&q=60')";
    front.style.backgroundImage ="url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1400&q=60')";
  }
}

/* Ennemi (choix + fallback) */
function pickEnemy(){ return (wave%10===0)? BOSS_LIST[Math.floor(((wave/10)-1)%BOSS_LIST.length)] : ENEMY_LIST[(wave-1)%ENEMY_LIST.length]; }
function setEnemy(){
  const meta=pickEnemy();
  enemyNameEl.textContent=meta.name;
  enemyImg.style.opacity="0";
  enemyImg.src=meta.img;
  let resolved=false;
  const done=()=>{ if(resolved) return; resolved=true; enemyImg.style.opacity="1"; };
  const fail=()=>{ if(resolved) return; resolved=true;
    enemyImg.src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Question_mark_alternate.svg/240px-Question_mark_alternate.svg.png";
    enemyImg.style.opacity="1";
  };
  enemyImg.onload=done; enemyImg.onerror=fail;
  setTimeout(()=>{ if(!resolved) fail(); },1200);
}

/* UI */
function updateBars(){ $("hpNow").textContent=Math.max(0,Math.floor(hpNow)); $("hpMax").textContent=Math.floor(hpMax);
  hpFill.style.width=Math.max(0,Math.min(100,hpNow/hpMax*100))+"%";
  $("phpNow").textContent=Math.max(0,Math.floor(phpNow)); $("phpMax").textContent=Math.floor(phpMax);
  phpFill.style.width=Math.max(0,Math.min(100,phpNow/phpMax*100))+"%"; }
function updateTop(){ $("waveTop").textContent=wave; $("wave").textContent=wave;
  goldEl.textContent=fmt(gold); gemsEl.textContent=fmt(gems); starsEl.textContent=fmt(stars);
  $("gpc").textContent=fmt(gpc); $("dps").textContent=fmt(dps);
  $("critRate").textContent=Math.min(100,critRate).toFixed(0);
  $("critMult").textContent=critMult.toFixed(2);
  $("dodge").textContent=Math.min(40,dodgePct).toFixed(0);
  $("regen").textContent=regenPerSec.toFixed(1);
  $("reward").textContent="+"+fmt(Math.round(rewardForWave(wave)))+((wave%10===0)?" (boss)":""); }

/* Scaling / R√©compenses / D√©g√¢ts */
function scaleForWave(w){ const base=[240,720,1800,3600,6800,14500][Math.min(5,Math.floor((w-1)/10))];
  const grow=[1.18,1.2,1.22,1.24,1.26,1.28][Math.min(5,Math.floor((w-1)/10))];
  const intra=(w-1)%10; let hp=Math.floor(base*Math.pow(grow,intra)*(w%10===0?8:1));
  if(w%10===0 && w>=50) hp=Math.floor(hp*(1+Math.min(2,(w-50)*.02))); return {hp}; }
function rewardForWave(w){ const base=[46,104,180,330,600,1100][Math.min(5,Math.floor((w-1)/10))];
  const grow=[1.16,1.18,1.2,1.22,1.24,1.26][Math.min(5,Math.floor((w-1)/10))];
  const intra=(w-1)%10; return Math.floor(base*Math.pow(grow,intra)*(w%10===0?4:1)); }
function enemyDamage(){ let d=Math.max(1,Math.round(wave*1.0)); if(wave%10===0) d=Math.floor(d*(wave>=50?2.2:1.4)); return d; }

/* Effets */
function float(txt,x,y,color){ const d=document.createElement("div"); d.className="float"; d.textContent=txt; d.style.left=x+"px"; d.style.top=y+"px"; d.style.color=color||"white"; document.body.appendChild(d); setTimeout(()=>d.remove(),900); }
function projectile(x,y,tx,ty,style){ const p=document.createElement("div"); p.style.position="fixed"; p.style.left=x+"px"; p.style.top=y+"px"; p.style.width="14px"; p.style.height="14px"; p.style.borderRadius="50%"; p.style.zIndex="998"; p.style.background=style==="enemy"?"radial-gradient(circle,#fff5cc,#ff9a5e,#ff6a3d)":"linear-gradient(180deg,#7fffd4,#b8ffe9)"; p.animate([{transform:"translate(0,0)",opacity:1},{transform:`translate(${tx-x}px,${ty-y}px)`,opacity:.25}],{duration:360,easing:"cubic-bezier(.2,.8,.2,1)"}); document.body.appendChild(p); setTimeout(()=>p.remove(),380); }

/* Combat */
function doDamage(base,rect){ let dmg=base; const isCrit=Math.random()*100<critRate; if(isCrit) dmg=Math.ceil(dmg*critMult); hpNow=Math.max(0,hpNow-dmg);
  enemyImg.classList.add('hit'); setTimeout(()=>enemyImg.classList.remove('hit'),180);
  float(isCrit?("-"+dmg+" ‚òÖ"):("-"+dmg),rect.left+rect.width/2,rect.top+10,isCrit?"#ffe887":"#ff9aa6"); }
function killCheck(rect){ if(hpNow>0) return; totalKills++; const r=rewardForWave(wave); gold+=r; float("+"+r+" ‚õÉ",rect.left+rect.width/2,rect.top+rect.height/2,"#ffd66b"); if(wave%10===0){ const drop=R(30,100); gems+=drop; float("+"+drop+" üíé",rect.left+rect.width/2,rect.top+6,"#79f2ff"); } wave++; newWave(); save(); }
function clickHit(){ if(hpNow<=0) return; totalClicks++; const rect=enemyImg.getBoundingClientRect(); projectile(rect.left+rect.width/2,rect.top+rect.height/2,rect.left+rect.width/2+40,rect.top+rect.height/2-6,"ally"); doDamage(atkBase,rect); const goldMult=1+PRESTIGE.find(p=>p.key==="gold").lvl*.10; gold+=Math.max(1,Math.floor(gpc*goldMult)); updateBars(); killCheck(rect); updateTop(); save(); }
function enemyAttack(){ if(hpNow<=0) return; const er=enemyImg.getBoundingClientRect(); const tx=innerWidth-60,ty=84; setTimeout(()=>{ projectile(er.left+er.width/2,er.top+er.height/2,tx,ty,"enemy"); setTimeout(()=>{ if(Math.random()*100<dodgePct){ float("√âVIT√â !",innerWidth-80,72,"#7fffd4"); return;} const dmg=enemyDamage(); phpNow=Math.max(0,phpNow-dmg); updateBars(); float("-"+dmg,innerWidth-80,74,"#ff8a8a"); if(phpNow===0){ onDeath(); } },340); },360); }

/* Vague / reset */
function newWave(){ const sc=scaleForWave(wave); hpMax=sc.hp; hpNow=hpMax; applyBiome(); setEnemy(); updateBars(); updateTop(); }
function computeStars(){ const bosses=Math.floor((wave-1)/10); return Math.max(1,Math.floor(wave/4)+bosses*2); }
function onDeath(){ stars+=computeStars(); wave=1; gold=0; clickShopData.forEach(u=>u.lvl=0); autoShopData.forEach(u=>u.lvl=0); dodgeShopData.forEach(u=>u.lvl=0); soldiers.forEach(s=>s.owned=0); recalc(); phpNow=phpMax; const sc=scaleForWave(wave); hpMax=sc.hp; hpNow=hpMax; newWave(); buildAll(); updateBars(); updateTop(); save(); }

/* SHOPS */
const clickShopData=[
 {name:"+1 Or/clic",  base:80,   growth:1.75, add:1,  lvl:0},
 {name:"+5 Or/clic",  base:520,  growth:1.75, add:5,  lvl:0},
 {name:"+20 Or/clic", base:2200, growth:1.75, add:20, lvl:0},
 {name:"+40 Or/clic", base:5200, growth:1.75, add:40, lvl:0}
];
const autoShopData=[
 {name:"+1 CPS",  base:60,   growth:1.7, add:1,  lvl:0},
 {name:"+5 CPS",  base:520,  growth:1.7, add:5,  lvl:0},
 {name:"+20 CPS", base:3800, growth:1.7, add:20, lvl:0},
 {name:"+40 CPS", base:9200, growth:1.7, add:40, lvl:0}
];
const dodgeShopData=[{name:"+1% Esquive auto",base:800,growth:1.5,add:1,lvl:0}];
const soldiers=[
 {rank:"E",name:"√âclaireur",base:120,growth:1.6,dps:4,owned:0},
 {rank:"D",name:"Archer elfe",base:460,growth:1.6,dps:18,owned:0},
 {rank:"C",name:"Guerrier orc",base:1900,growth:1.6,dps:90,owned:0},
 {rank:"B",name:"Mage azur",base:8200,growth:1.6,dps:420,owned:0},
 {rank:"A",name:"Chevalier runique",base:38000,growth:1.6,dps:2100,owned:0},
 {rank:"S",name:"Dragon noir",base:160000,growth:1.6,dps:9800,owned:0}
];

const gemHeroes=[
 {rank:"SS", name:"Seigneur Orque", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/5/50/Orc_head_icon.png/160px-Orc_head_icon.png", costBase:10000, growth:2.0, baseDps:260000, owned:0, lvl:0, xp:0, xpNext:140, perk:"gold"},
 {rank:"SS", name:"D√©moniste √âcarlate", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/2/2c/Demon_head_icon.png/160px-Demon_head_icon.png", costBase:20000, growth:2.0, baseDps:360000, owned:0, lvl:0, xp:0, xpNext:140, perk:"regen"},
 {rank:"SSS",name:"Dragon Empyr√©en", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/1/11/Dragon_head_icon.png/160px-Dragon_head_icon.png", costBase:40000, growth:2.0, baseDps:1200000, owned:0, lvl:0, xp:0, xpNext:160, perk:"dps"},
 {rank:"SSS",name:"Prince Gobelin", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/7/78/Goblin_head_icon.png/160px-Goblin_head_icon.png", costBase:80000, growth:2.0, baseDps:1800000, owned:0, lvl:0, xp:0, xpNext:160, perk:"crit"}
];
const GEM_UPGRADES=[
 {key:"gCritR",name:"+1% Taux Crit",icon:"‚≠ê",costBase:120,growth:1.7,lvl:0},
 {key:"gCritM",name:"+0,1√ó D√©g√¢ts Crit",icon:"üí•",costBase:160,growth:1.72,lvl:0},
 {key:"gGpc", name:"+5 Or/clic",   icon:"üñ±Ô∏è",costBase:110,growth:1.7,lvl:0},
 {key:"gRegen",name:"+0,5 PV/s",    icon:"‚ûï",costBase:120,growth:1.68,lvl:0},
 {key:"gVital",name:"+100 PV Max",  icon:"‚ù§Ô∏è",costBase:190,growth:1.7,lvl:0},
 {key:"gDodge",name:"+1% Esquive",  icon:"üõ°Ô∏è",costBase:150,growth:1.68,lvl:0},
 {key:"gDps",  name:"+5% DPS",      icon:"‚öîÔ∏è",costBase:220,growth:1.75,lvl:0}
];
const PRESTIGE=[
 {key:"gold",  name:"+10% Or", base:3,growth:1.6,inc:.10,lvl:0},
 {key:"power", name:"+10% DPS",base:3,growth:1.6,inc:.10,lvl:0},
 {key:"regen", name:"+0,5 PV/s",base:2,growth:1.5,inc:.5,lvl:0},
 {key:"vital", name:"+100 PV", base:2,growth:1.5,inc:100,lvl:0},
 {key:"click", name:"+1 Or/clic",base:2,growth:1.7,inc:1,lvl:0},
 {key:"attack",name:"+1 Attaque", base:2,growth:1.7,inc:1,lvl:0},
 {key:"critR", name:"+2% Crit", base:3,growth:1.7,inc:2,lvl:0},
 {key:"critM", name:"+0,2√ó Crit",base:3,growth:1.75,inc:.2,lvl:0}
];
const DUNGEONS=[
 {key:"D1",name:"Caveau gobelin",reqWave:1,xp:35,gemChance:.06,cooldown:5000,last:0},
 {key:"D2",name:"Crat√®re orc",reqWave:12,xp:90,gemChance:.08,cooldown:5500,last:0},
 {key:"D3",name:"Faille d√©mon",reqWave:28,xp:210,gemChance:.12,cooldown:6000,last:0},
 {key:"D4",name:"Sanctuaire drake",reqWave:52,xp:460,gemChance:.16,cooldown:6500,last:0}
];
const QUESTS=[
 {key:"q_clicks",name:"Cliquer 100 fois",type:"clicks",target:100,reward:60,done:false,claimed:false},
 {key:"q_kills", name:"Vaincre 50 ennemis",type:"kills",target:50,reward:90,done:false,claimed:false},
 {key:"q_wave",  name:"Atteindre la vague 25",type:"wave",target:25,reward:140,done:false,claimed:false},
 {key:"q_hero",  name:"Recruter 1 h√©ros üíé",type:"hero",target:1,reward:200,done:false,claimed:false}
];

/* Recalc */
function gemLvl(key){const u=GEM_UPGRADES.find(x=>x.key===key); return u?u.lvl:0;}
function heroCost(h){return Math.floor(h.costBase*Math.pow(h.growth,h.owned));}
function heroDps(h){return h.owned>0?Math.floor(h.baseDps*(1+0.25*h.lvl))*h.owned:0;}
function heroPerkTiers(h){return Math.floor(h.lvl/10);}
function totalHeroDps(){return gemHeroes.reduce((s,h)=>s+heroDps(h),0);}
function recalc(){
  autoClicks=autoShopData.reduce((s,u)=>s+(u.add||0)*(u.lvl||0),0);
  let addDPS=soldiers.reduce((s,o)=>s+o.dps*(o.owned||0),0)+totalHeroDps();
  const powMult=(1+PRESTIGE.find(p=>p.key==="power").lvl*.10)*(1+gemLvl("gDps")*.05);
  dps=Math.floor(addDPS*powMult);
  const clickBase=1+PRESTIGE.find(p=>p.key==="click").lvl*1+gemLvl("gGpc")*5 + clickShopData.reduce((s,u)=>s+(u.lvl||0)*(u.add||0),0);
  gpc=Math.floor(clickBase);
  regenPerSec=1.0+PRESTIGE.find(p=>p.key==="regen").lvl*.5+gemLvl("gRegen")*.5;
  atkBase=1+PRESTIGE.find(p=>p.key==="attack").lvl;
  critRate=PRESTIGE.find(p=>p.key==="critR").lvl*2+gemLvl("gCritR")*1;
  critMult=(1.5+PRESTIGE.find(p=>p.key==="critM").lvl*.2)+gemLvl("gCritM")*.1;
  dodgePct=Math.min(40,5+(dodgeShopData[0].lvl||0)*1+gemLvl("gDodge")*1);
  phpMax=100+PRESTIGE.find(p=>p.key==="vital").lvl*100+gemLvl("gVital")*100;
  if(phpNow>phpMax) phpNow=phpMax;
}

/* Achats utils */
function bulkCost(base,growth,lvl,qty){ if(qty<=0) return 0; const start=base*Math.pow(growth,lvl); return Math.floor(start*(Math.pow(growth,qty)-1)/(growth-1)); }
function nextCost(base,growth,lvl){return Math.floor(base*Math.pow(growth,lvl));}
function maxAffordable(base,growth,lvl,bank){ let lo=0,hi=1; while(bulkCost(base,growth,lvl,hi)<=bank){lo=hi;hi*=2;if(hi>1e6)break;} while(lo<hi){ const mid=Math.ceil((lo+hi)/2); if(bulkCost(base,growth,lvl,mid)<=bank){lo=mid;} else hi=mid-1; } return lo; }

/* Build shops */
const clickShopDiv=$("clickShop"),autoShopDiv=$("autoShop"),soldierShopDiv=$("soldierShop"),dodgeShopDiv=$("dodgeShop"),gemShopDiv=$("gemShop"),gemUpgShopDiv=$("gemUpgShop"),prestigeShopDiv=$("prestigeShop"),dungeonGrid=$("dungeonGrid"),questGrid=$("questGrid");

function buildClickShop(){ clickShopDiv.innerHTML=""; clickShopData.forEach(u=>{ const total=bulkCost(u.base,u.growth,u.lvl,buyQty),unit=nextCost(u.base,u.growth,u.lvl); const row=document.createElement("div"); row.className="item gold"; row.innerHTML=`<div class="ico">üñ±</div><div class="grow"><div><b>${u.name}</b></div><small>Niv ${u.lvl} ‚Ä¢ Unit√© ${fmt(unit)} ‚Ä¢ x${buyQty} ${fmt(total)}</small></div>`; const btn=document.createElement("button"); btn.className="btn gold"; btn.textContent=fmt(total)+" ‚õÉ"; btn.onclick=()=>{ const m=maxAffordable(u.base,u.growth,u.lvl,gold); if(m<=0)return; const q=Math.min(buyQty,m); gold-=bulkCost(u.base,u.growth,u.lvl,q); u.lvl+=q; recalc(); updateTop(); buildClickShop(); save(); }; row.appendChild(btn); clickShopDiv.appendChild(row); }); }
function buildAutoShop(){ autoShopDiv.innerHTML=""; autoShopData.forEach(u=>{ const total=bulkCost(u.base,u.growth,u.lvl||0,buyQty),unit=nextCost(u.base,u.growth,u.lvl||0); const row=document.createElement("div"); row.className="item gold"; row.innerHTML=`<div class="ico">‚öôÔ∏è</div><div class="grow"><div><b>${u.name}</b></div><small>Lvl ${u.lvl||0} ‚Ä¢ +${u.add} CPS/niv ‚Ä¢ Unit√© ${fmt(unit)} ‚Ä¢ x${buyQty} ${fmt(total)}</small></div>`; const btn=document.createElement("button"); btn.className="btn gold"; btn.textContent=fmt(total)+" ‚õÉ"; btn.onclick=()=>{ const m=maxAffordable(u.base,u.growth,u.lvl||0,gold); if(m<=0)return; const q=Math.min(buyQty,m); gold-=bulkCost(u.base,u.growth,u.lvl||0,q); u.lvl=(u.lvl||0)+q; autoClicks+=u.add*q; updateTop(); buildAutoShop(); save(); }; row.appendChild(btn); autoShopDiv.appendChild(row); }); }
function buildDodgeShop(){ dodgeShopDiv.innerHTML=""; dodgeShopData.forEach(u=>{ const total=bulkCost(u.base,u.growth,u.lvl||0,buyQty),unit=nextCost(u.base,u.growth,u.lvl||0); const row=document.createElement("div"); row.className="item gold"; row.innerHTML=`<div class="ico">üõ°Ô∏è</div><div class="grow"><div><b>${u.name}</b></div><small>Lvl ${u.lvl||0} ‚Ä¢ +${u.add}%/niv ‚Ä¢ Unit√© ${fmt(unit)} ‚Ä¢ x${buyQty} ${fmt(total)}</small></div>`; const btn=document.createElement("button"); btn.className="btn gold"; btn.textContent=fmt(total)+" ‚õÉ"; btn.onclick=()=>{ const m=maxAffordable(u.base,u.growth,u.lvl||0,gold); if(m<=0)return; const q=Math.min(buyQty,m); gold-=bulkCost(u.base,u.growth,u.lvl||0,q); u.lvl=(u.lvl||0)+q; dodgePct=Math.min(40,dodgePct+u.add*q); updateTop(); buildDodgeShop(); save(); }; row.appendChild(btn); dodgeShopDiv.appendChild(row); }); }
function buildSoldierShop(){ soldierShopDiv.innerHTML=""; soldiers.forEach(s=>{ const total=bulkCost(s.base,s.growth,s.owned,buyQty),unit=nextCost(s.base,s.growth,s.owned); const row=document.createElement("div"); row.className="item gold"; row.innerHTML=`<div class="ico">üéñÔ∏è</div><div class="grow"><div><span style="font-weight:900">Rang ${s.rank}</span> ‚Äî ${s.name}</div><small>Poss√©d√©s ${s.owned} ‚Ä¢ DPS/u ${fmt(s.dps)} ‚Ä¢ Unit√© ${fmt(unit)} ‚Ä¢ x${buyQty} ${fmt(total)}</small></div>`; const btn=document.createElement("button"); btn.className="btn gold"; btn.textContent=fmt(total)+" ‚õÉ"; btn.onclick=()=>{ const m=maxAffordable(s.base,s.growth,s.owned,gold); if(m<=0)return; const q=Math.min(buyQty,m); gold-=bulkCost(s.base,s.growth,s.owned,q); s.owned+=q; recalc(); updateTop(); buildSoldierShop(); save(); }; row.appendChild(btn); soldierShopDiv.appendChild(row); }); }

function gemUpgCost(u){ return Math.floor(u.costBase*Math.pow(u.growth,u.lvl)); }
function buildGemUpgShop(){ gemUpgShopDiv.innerHTML=""; GEM_UPGRADES.forEach(u=>{ const cost=gemUpgCost(u); const row=document.createElement("div"); row.className="item gem"; row.innerHTML=`<div class="ico">${u.icon}</div><div class="grow"><div><b>${u.name}</b></div><small>Niv ${u.lvl} ‚Ä¢ Co√ªt ${cost} üíé</small></div>`; const btn=document.createElement("button"); btn.className="btn gem"; btn.textContent=fmt(cost)+" üíé"; btn.onclick=()=>{ if(gems<cost)return; gems-=cost; u.lvl++; recalc(); updateBars(); updateTop(); buildGemUpgShop(); save(); }; row.appendChild(btn); gemUpgShopDiv.appendChild(row); }); }
function perkDesc(h){ const t=Math.floor(h.lvl/10); if(t<=0)return ""; if(h.perk==="gold")return ` ‚Ä¢ +${t*5}% or`; if(h.perk==="dps")return ` ‚Ä¢ +${t*8}% DPS`; if(h.perk==="crit")return ` ‚Ä¢ +${t}% crit`; if(h.perk==="regen")return ` ‚Ä¢ +${(t*0.2).toFixed(1)} PV/s`; return ""; }
function buildGemShop(){ gemShopDiv.innerHTML=""; gemHeroes.forEach(h=>{ const cost=heroCost(h); const row=document.createElement("div"); row.className="item gem"; row.innerHTML=`<img class="heroPic" src="${h.img}"><div class="grow"><div><span style="font-weight:900">Rang ${h.rank}</span> ‚Äî ${h.name}</div><small>Poss√©d√©s ${h.owned} ‚Ä¢ DPS ${fmt(h.owned?Math.floor(h.baseDps*(1+0.25*h.lvl))*h.owned:h.baseDps)} ‚Ä¢ Lvl ${h.lvl} (${h.xp}/${h.xpNext})${perkDesc(h)}</small></div>`; const btn=document.createElement("button"); btn.className="btn gem"; btn.textContent=fmt(cost)+" üíé"; btn.onclick=()=>{ if(gems<cost)return; gems-=cost; h.owned++; recalc(); updateTop(); buildGemShop(); updateQuestsProgress(); save(); }; row.appendChild(btn); gemShopDiv.appendChild(row); }); }
function buildPrestigeShop(){ prestigeShopDiv.innerHTML=""; PRESTIGE.forEach(p=>{ const cost=Math.floor(p.base*Math.pow(p.growth,p.lvl)); const row=document.createElement("div"); row.className="item star"; row.innerHTML=`<div class="ico">‚≠ê</div><div class="grow"><div><b>${p.name}</b></div><small>Niv ${p.lvl} ‚Ä¢ Co√ªt ${cost} ‚≠ê</small></div>`; const btn=document.createElement("button"); btn.className="btn star"; btn.textContent=`${cost} ‚≠ê`; btn.onclick=()=>{ if(stars<cost)return; stars-=cost; p.lvl++; recalc(); updateBars(); updateTop(); buildPrestigeShop(); save(); }; row.appendChild(btn); prestigeShopDiv.appendChild(row); }); }
function buildDungeon(){ dungeonGrid.innerHTML=""; DUNGEONS.forEach(d=>{ const ready=Date.now()-d.last>=d.cooldown; const row=document.createElement("div"); row.className="item"; row.innerHTML=`<div class="ico">üè∞</div><div class="grow"><div><b>${d.name}</b> ‚Äî req vague ${d.reqWave}</div><small>Gain ${d.xp} XP ‚Ä¢ Gemmes ${(d.gemChance*100).toFixed(0)}% ‚Ä¢ CD ${(d.cooldown/1000).toFixed(1)}s${ready?"":" ‚Ä¢ ‚è≥"}</small></div>`; const btn=document.createElement("button"); btn.className="btn gem"; btn.textContent=ready?"Lancer":"‚è≥"; btn.disabled=!ready||wave<d.reqWave; btn.onclick=()=>{ if(btn.disabled)return; d.last=Date.now(); giveHeroXp(d.xp); if(Math.random()<d.gemChance){ const bonus=R(10,30); gems+=bonus; updateTop(); float("+"+bonus+" üíé (Donjon)",innerWidth/2,120,"#79f2ff");} buildDungeon(); save(); }; row.appendChild(btn); dungeonGrid.appendChild(row); }); }
function updateQuestsProgress(){ QUESTS.forEach(q=>{ if(q.done)return; if(q.type==="clicks"&&totalClicks>=q.target)q.done=true; if(q.type==="kills"&&totalKills>=q.target)q.done=true; if(q.type==="wave"&&wave>=q.target)q.done=true; if(q.type==="hero"&&gemHeroes.some(h=>h.owned>0))q.done=true; }); buildQuests(); }
function buildQuests(){ questGrid.innerHTML=""; QUESTS.forEach(q=>{ const row=document.createElement("div"); row.className="item"; const progress=(q.type==="clicks")?Math.min(totalClicks,q.target):(q.type==="kills")?Math.min(totalKills,q.target):(q.type==="wave")?Math.min(wave-1,q.target):(q.type==="hero")?(gemHeroes.some(h=>h.owned>0)?q.target:0):0; row.innerHTML=`<div class="ico">üìú</div><div class="grow"><div><b>${q.name}</b></div><small>Progression ${progress}/${q.target} ‚Ä¢ R√©compense ${q.reward} üíé</small></div>`; const btn=document.createElement("button"); btn.className="btn gem"; btn.textContent=q.claimed?"R√©clam√©e":(q.done?"R√©clamer":"En cours"); btn.disabled=!q.done||q.claimed; btn.onclick=()=>{ if(q.done&&!q.claimed){ q.claimed=true; gems+=q.reward; updateTop(); float("+"+q.reward+" üíé (Qu√™te)",innerWidth/2,140,"#79f2ff"); buildQuests(); save(); } }; row.appendChild(btn); questGrid.appendChild(row); }); }

function buildAll(){ buildClickShop(); buildAutoShop(); buildDodgeShop(); buildSoldierShop(); buildGemShop(); buildGemUpgShop(); buildPrestigeShop(); buildDungeon(); buildQuests(); }

/* H√©ros XP */
function giveHeroXp(amount){ const owned=gemHeroes.filter(h=>h.owned>0); if(!owned.length) return; const per=Math.max(1,Math.floor(amount/owned.length)); owned.forEach(h=>{ let tier=heroPerkTiers(h); h.xp+=per; while(h.xp>=h.xpNext){ h.xp-=h.xpNext; h.lvl++; h.xpNext=Math.floor(h.xpNext*1.4+10); const t2=heroPerkTiers(h); if(t2>tier){ float(`‚ú® Perk ${h.name}`, innerWidth/2, 120, "#ffe887"); tier=t2; }}}); recalc(); updateTop(); buildGemShop(); buildQuests(); }

/* Save/Load */
function save(){ try{ localStorage.setItem("ch:save:full",JSON.stringify({gold,gems,stars,wave,phpMax,phpNow,gpc,dps,autoClicks,dodgePct,atkBase,critRate,critMult,regenPerSec,clickShopData,autoShopData,dodgeShopData,soldiers,gemHeroes,GEM_UPGRADES,PRESTIGE,DUNGEONS,QUESTS,last:Date.now()})); }catch(e){} }
function load(){ try{ const raw=localStorage.getItem("ch:save:full"); if(!raw) return; const d=JSON.parse(raw); Object.assign(window,{gold:0},d);
  ["clickShopData","autoShopData","dodgeShopData"].forEach(k=>d[k]&&d[k].forEach((u,i)=>{ if(window[k][i]) window[k][i].lvl=u.lvl; }));
  soldiers.forEach((s,i)=>{ if(d.soldiers&&d.soldiers[i]) s.owned=d.soldiers[i].owned; });
  if(d.gemHeroes) d.gemHeroes.forEach((h,i)=>{ if(gemHeroes[i]) Object.assign(gemHeroes[i],{owned:h.owned,lvl:h.lvl,xp:h.xp,xpNext:h.xpNext}); });
  if(d.GEM_UPGRADES) d.GEM_UPGRADES.forEach((u,i)=>{ if(GEM_UPGRADES[i]) GEM_UPGRADES[i].lvl=u.lvl; });
  if(d.PRESTIGE) d.PRESTIGE.forEach((p,i)=>{ if(PRESTIGE[i]) PRESTIGE[i].lvl=p.lvl; }); }catch(e){} }

/* Listeners nav */
document.querySelectorAll(".navInner button[data-goto]").forEach(b=>b.addEventListener("click",()=>{ 
  document.querySelectorAll(".navInner button").forEach(x=>x.classList.remove("active")); 
  b.classList.add("active"); 
  const goto=b.getAttribute("data-goto"); 
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active",t.getAttribute("data-tab")===goto));
  // scroll top de l'onglet actif
  const activeBody = document.querySelector('.tab.active .tabBody');
  activeBody && activeBody.scrollTo({ top: 0, behavior: 'instant' });
}));
document.querySelectorAll("[data-q]").forEach(b=>b.addEventListener("click",()=>{ document.querySelectorAll("[data-q]").forEach(x=>x.classList.remove("active")); b.classList.add("active"); buyQty=parseInt(b.getAttribute("data-q"),10)||1; }));
$("hitBtn").onclick=$("hitZone").onclick=$("enemyImg").onclick=clickHit;
$("saveBtn").onclick=()=>{ save(); float("Sauvegard√© ‚úî",innerWidth/2,70,"#b8ffe9"); };
$("resetBtn").onclick=()=>{ if(confirm("Ascension maintenant ?")) onDeath(); };

/* Install PWA bouton */
let deferredPrompt=null; const $ib=document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', e=>{ e.preventDefault(); deferredPrompt=e; if($ib) $ib.style.display='inline-block'; });
$ib?.addEventListener('click', async ()=>{ if(!deferredPrompt) return; $ib.disabled=true; deferredPrompt.prompt(); const {outcome}=await deferredPrompt.userChoice; deferredPrompt=null; if(outcome!=='accepted') $ib.disabled=false; });
window.addEventListener('appinstalled',()=>{ if($ib) $ib.style.display='none'; });

/* Init */
(function start(){ applyBiome(); setEnemy(); const sc=scaleForWave(wave); hpMax=sc.hp; hpNow=hpMax; recalc(); buildAll(); updateBars(); updateTop(); load(); recalc(); updateBars(); updateTop(); buildAll(); })();

/* Boucles */
setInterval(()=>{ const per=dps/10; if(per<=0||hpNow<=0) return; const rect=enemyImg.getBoundingClientRect(); let dmg=Math.max(1,Math.floor(per)); if(Math.random()*100<critRate) dmg=Math.ceil(dmg*critMult); hpNow=Math.max(0,hpNow-dmg); document.querySelector('.s-man')?.classList.add('swing'); setTimeout(()=>document.querySelector('.s-man')?.classList.remove('swing'),240); float("-"+fmt(dmg),rect.left+rect.width/2+12,rect.top+18,"#ffdf7a"); updateBars(); killCheck(rect); },100);
setInterval(()=>{ if(autoClicks<=0||hpNow<=0) return; const rect=enemyImg.getBoundingClientRect(); const per=autoClicks/4; const n=Math.floor(per)+(Math.random()<(per-Math.floor(per))?1:0); const goldMult=1+PRESTIGE.find(p=>p.key==="gold").lvl*.10; document.querySelector('.s-man')?.classList.add('swing'); setTimeout(()=>document.querySelector('.s-man')?.classList.remove('swing'),240); for(let i=0;i<n;i++){ doDamage(atkBase,rect); projectile(rect.left+rect.width/2,rect.top+rect.height/2,rect.left+rect.width/2+20,rect.top+rect.height/2-4,"ally"); gold+=Math.max(1,Math.floor(gpc*goldMult)); } updateBars(); killCheck(rect); updateTop(); },250);
setInterval(()=>{ if(Math.random()<0.65) enemyAttack(); },1200);
setInterval(()=>{ if(regenPerSec>0 && phpNow>0 && phpNow<phpMax){ const heal=Math.min(regenPerSec,phpMax-phpNow); phpNow+=heal; updateBars(); } },1000);
setInterval(()=>{ QUESTS && updateQuestsProgress(); },800);
setInterval(save,30000); window.addEventListener("beforeunload",save);
})();</script>

<!-- Service Worker + auto-reload -->
<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js').then(reg=>{
    if(reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
    reg.addEventListener('updatefound',()=>{
      const nw=reg.installing;
      nw && nw.addEventListener('statechange',()=>{
        if(nw.state==='installed' && navigator.serviceWorker.controller){ location.reload(); }
      });
    });
  });
  navigator.serviceWorker.addEventListener('controllerchange',()=>location.reload());
}
</script>
</body>
</html>
