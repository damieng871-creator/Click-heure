<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Click’Heure — Leew11</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0f2a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Click’Heure">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
:root{--txt:#e9efff;--mut:#a9b5ff;--gold:#ffd978;--gem:#7af2ff;--bg1:#0b0f2a;--bg2:#080b1e;--hp:#ff6a6a;--hp2:#ffa86a;--php:#8affdf;--php2:#b6ffe9}
*{box-sizing:border-box}html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;-webkit-tap-highlight-color:transparent}
.wrap{max-width:1100px;margin:0 auto}
header{position:sticky;top:0;z-index:40;backdrop-filter:blur(10px);background:linear-gradient(180deg,rgba(12,18,45,.85),rgba(7,10,24,.7));border-bottom:1px solid rgba(255,255,255,.08)}
.head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px}
.pill{display:inline-flex;align-items:center;gap:6px;padding:.4rem .6rem;border-radius:999px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.12);color:var(--mut);font-weight:800}
.pill b{color:var(--txt)}
main{padding:12px 12px 110px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.35)}
.sectionTitle{display:flex;align-items:center;gap:10px;padding:12px;margin:0;font-weight:900}
.sectionTitle.gold{color:#ffe48a}.sectionTitle.gem{color:#9bf1ff}.sectionTitle.star{color:#ffe27a}
.stage{position:relative;overflow:hidden}
.bg{position:absolute;inset:0;pointer-events:none;z-index:0;transition:background 500ms ease}
.bg::after{content:"";position:absolute;inset:auto 0 0 0;height:44%;background-repeat:no-repeat;background-position:bottom center;background-size:cover;opacity:.18}
.enemyWrap{position:relative;height:330px;display:flex;align-items:center;justify-content:center;z-index:2}
#enemyImg{width:260px;height:260px;object-fit:contain;border-radius:18px;filter:drop-shadow(0 18px 38px rgba(0,0,0,.55));animation:float 3.2s ease-in-out infinite}
@keyframes float{50%{transform:translateY(-4px) scale(1.02)}}
.bar{position:relative;height:20px;background:#131a42;border:1px solid rgba(255,255,255,.12);border-radius:10px;overflow:hidden;margin:10px 14px}
.fill{position:absolute;left:0;top:0;height:100%;width:100%;background:linear-gradient(90deg,var(--hp),var(--hp2));transition:width .25s}
.hpP .fill{background:linear-gradient(90deg,var(--php),var(--php2))}
.row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.small{opacity:.9;color:var(--mut);padding:0 14px 10px}
.btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:900;color:#0a0f1e;cursor:pointer;background:linear-gradient(180deg,#fff,#eef1ff);box-shadow:0 12px 26px rgba(0,0,0,.35), inset 0 -6px 12px rgba(100,100,255,.1)}
.btn.gold{background:linear-gradient(180deg,#fff3c6,#ffe48a)}.btn.gem{background:linear-gradient(180deg,#e6fbff,#b8f2ff)}.btn.star{background:linear-gradient(180deg,#fff6cc,#ffe27a)}
.btn:active{transform:translateY(1px)}
.actions{display:flex;gap:10px;padding:12px;flex-wrap:wrap}
.tabs{display:grid;grid-template-columns:1fr}.tab{display:none}.tab.active{display:block}
nav{position:sticky;bottom:0;z-index:30;background:linear-gradient(180deg,rgba(8,10,24,.2),rgba(6,9,21,.9));backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,.08)}
.navInner{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;padding:10px 14px}
.navInner button{padding:.75rem;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:var(--txt);font-weight:900}
.navInner button.active{background:#fff;color:#0a0f1e}
.shopGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px}
.item{display:flex;gap:12px;align-items:center;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}
.item.gold{border-color:#ffe48a55}.item.gem{border-color:#9bf1ff55}.item.star{border-color:#ffe27a55}
.ico{min-width:46px;min-height:46px;border-radius:12px;display:grid;place-items:center;background:radial-gradient(circle at 30% 30%, #fff, #e9efff)}
.heroPic{width:56px;height:56px;border-radius:12px;object-fit:cover;border:1px solid rgba(255,255,255,.18)}
.float{position:fixed;pointer-events:none;font-weight:900;font-size:16px;text-shadow:0 2px 0 rgba(0,0,0,.5);animation:pop .9s ease-out forwards;z-index:999}
@keyframes pop{to{opacity:0;transform:translateY(-44px) scale(.96)}}
.version{position:fixed;right:8px;bottom:8px;opacity:.85;font-weight:800;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);padding:.2rem .5rem;border-radius:10px;z-index:60}
</style>
</head>
<body>

<header>
  <div class="wrap head">
    <strong>Click’Heure — <span style="opacity:.8">Leew11</span></strong>
    <div class="pill">🌊 Vague <b id="waveTop">1</b></div>
    <div class="pill">⛃ <b id="gold">0</b></div>
    <div class="pill">💎 <b id="gems">0</b></div>
    <div class="pill">⭐ <b id="stars">0</b></div>
  </div>
</header>

<main class="wrap">
  <section class="tabs">
    <!-- COMBAT -->
    <div class="tab active" data-tab="combat">
      <div class="card stage" id="enemyArea">
        <div class="bg" id="biomeBg"></div>
        <div class="row" style="justify-content:space-between;padding:10px 14px">
          <span class="pill">Vague <b id="wave">1</b> <span id="bossTag"></span></span>
          <span class="pill">Ennemi: <b id="enemyName">—</b></span>
          <span class="pill">Butin: <b id="reward">+0</b></span>
        </div>
        <div class="bar"><div class="fill" id="hpFill"></div></div>
        <div class="enemyWrap" id="hitZone">
          <img id="enemyImg" alt="ennemi">
        </div>
        <div class="bar hpP"><div class="fill" id="phpFill"></div></div>
        <div class="row small">
          <span>PV Ennemi <b id="hpNow">0</b>/<b id="hpMax">0</b></span>
          <span>PV Joueur <b id="phpNow">0</b>/<b id="phpMax">0</b></span>
          <span class="pill">🖱 <b id="gpc">1</b></span>
          <span class="pill">⚔️ <b id="dps">0</b></span>
          <span class="pill">⭐ Crit% <b id="critRate">0</b></span>
          <span class="pill">⭐ Crit× <b id="critMult">1.5</b></span>
          <span class="pill">🛡️ Esquive <b id="dodge">5</b>%</span>
          <span class="pill">➕ Regen <b id="regen">1.0</b>/s</span>
        </div>
        <div class="row actions">
          <button class="btn gold" id="hitBtn">⚔️ Attaquer</button>
          <button class="btn" id="saveBtn">💾 Sauver</button>
          <button class="btn" id="resetBtn">🔄 Ascension</button>
        </div>
      </div>
    </div>

    <!-- SHOP OR -->
    <div class="tab" data-tab="shop">
      <div class="card" style="margin-top:14px">
        <h3 class="sectionTitle gold">⛃ Boutique Or</h3>
        <div class="row" style="gap:8px;padding:8px 12px">
          <span class="pill">Quantité</span>
          <button data-q="1" class="btn gold" style="padding:.35rem .6rem">x1</button>
          <button data-q="10" class="btn gold" style="padding:.35rem .6rem">x10</button>
          <button data-q="100" class="btn gold" style="padding:.35rem .6rem">x100</button>
        </div>
        <div class="shopGrid" id="clickShop"></div>
        <div class="shopGrid" id="autoShop"></div>
        <div class="shopGrid" id="dodgeShop"></div>
        <div class="shopGrid" id="soldierShop"></div>
      </div>
    </div>

    <!-- SHOP GEM -->
    <div class="tab" data-tab="gem">
      <div class="card" style="margin-top:14px">
        <h3 class="sectionTitle gem">💎 Héros (Gem)</h3>
        <div class="shopGrid" id="gemShop"></div>
        <h3 class="sectionTitle gem">💎 Améliorations (Gem)</h3>
        <div class="shopGrid" id="gemUpgShop"></div>
      </div>
    </div>

    <!-- SHOP ETOILES -->
    <div class="tab" data-tab="star">
      <div class="card" style="margin-top:14px;padding-bottom:12px">
        <h3 class="sectionTitle star">⭐ Shop 2 — Ascension</h3>
        <p class="small">Les étoiles sont gagnées quand ta vie tombe à 0 (reset). Les <b>gemmes et héros (gem)</b> sont conservés.</p>
        <div class="shopGrid" id="prestigeShop"></div>
      </div>
    </div>

    <!-- DONJON -->
    <div class="tab" data-tab="dungeon">
      <div class="card" style="margin-top:14px;padding-bottom:12px">
        <h3 class="sectionTitle">🏰 Donjons (XP héros)</h3>
        <div class="shopGrid" id="dungeonGrid"></div>
      </div>
    </div>

    <!-- QUÊTES -->
    <div class="tab" data-tab="quests">
      <div class="card" style="margin-top:14px;padding-bottom:12px">
        <h3 class="sectionTitle">📜 Quêtes (gemmes)</h3>
        <div class="shopGrid" id="questGrid"></div>
      </div>
    </div>
  </section>
</main>

<nav>
  <div class="wrap navInner">
    <button class="active" data-goto="combat">⚔️ Combat</button>
    <button data-goto="shop">🛒 Or</button>
    <button data-goto="gem">💎 Gem</button>
    <button data-goto="star">⭐ Étoiles</button>
    <button data-goto="dungeon">🏰 Donjon</button>
    <button data-goto="quests">📜 Quêtes</button>
  </div>
</nav>

<div class="version">Click’Heure — build complet</div>

<script>
(()=>{ // ====== UTIL ======
const $=id=>document.getElementById(id), fmt=n=>Math.floor(n).toLocaleString(), R=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const biomeBg=$("biomeBg"), enemyImg=$("enemyImg"), enemyNameEl=$("enemyName");
const hpFill=$("hpFill"),phpFill=$("phpFill");
const goldEl=$("gold"), gemsEl=$("gems"), starsEl=$("stars");

let gold=0,gems=0,stars=0,wave=1,buyQty=1,totalClicks=0,totalKills=0;
let gpc=1,dps=0,autoClicks=0,atkBase=1,critRate=0,critMult=1.5,dodgePct=5,regenPerSec=1;
let phpMax=100,phpNow=100,hpMax=160,hpNow=160;

const enemies=[ // visuels externes (croquis fantasy)
 {name:"Gobelin sournois", img:"https://images.unsplash.com/photo-1619045119136-349759036541?auto=format&fit=crop&w=360&q=60"},
 {name:"Orc maraudeur",   img:"https://images.unsplash.com/photo-1608330176835-85a0c3e3e27d?auto=format&fit=crop&w=360&q=60"},
 {name:"Démon mineur",    img:"https://images.unsplash.com/photo-1618333451270-8f1e6f2eacad?auto=format&fit=crop&w=360&q=60"},
 {name:"Dragonnet",       img:"https://images.unsplash.com/photo-1612036782180-6b3f3b6a5aa0?auto=format&fit=crop&w=360&q=60"}
];
const bosses=[
 {name:"Seigneur Démon", img:"https://images.unsplash.com/photo-1549880338-8f9b9f4bdec0?auto=format&fit=crop&w=420&q=60"},
 {name:"Chef de Guerre Orc", img:"https://images.unsplash.com/photo-1545444221-3ca4b3e6b9a6?auto=format&fit=crop&w=420&q=60"},
 {name:"Dragon Ancien", img:"https://images.unsplash.com/photo-1549880338-65ddcdfd017b?auto=format&fit=crop&w=420&q=60"}
];

// --- équilibrages rapides
function scaleForWave(w){ const base=[240,720,1800,3600,6800,14500][Math.min(5,Math.floor((w-1)/10))]; const grow=[1.18,1.2,1.22,1.24,1.26,1.28][Math.min(5,Math.floor((w-1)/10))]; const intra=(w-1)%10; let hp=Math.floor(base*Math.pow(grow,intra)*(w%10===0?8:1)); if(w%10===0 && w>=50) hp=Math.floor(hp*(1+Math.min(2,(w-50)*.02))); return {hp}; }
function rewardForWave(w){ const base=[46,104,180,330,600,1100][Math.min(5,Math.floor((w-1)/10))]; const grow=[1.16,1.18,1.2,1.22,1.24,1.26][Math.min(5,Math.floor((w-1)/10))]; const intra=(w-1)%10; return Math.floor(base*Math.pow(grow,intra)*(w%10===0?4:1)); }
function enemyDamage(){ let d=Math.max(1,Math.round(wave*1.0)); if(wave%10===0) d=Math.floor(d*(wave>=50?2.2:1.4)); return d; }

// --- shops data
const clickShopData=[{name:"+100 PV max",base:120,growth:1.7,apply:()=>{phpMax+=100;phpNow+=100},lvl:0},
                     {name:"+1 Or/clic", base:80,growth:1.75,apply:()=>{gpc+=1},lvl:0},
                     {name:"+5 Or/clic", base:520,growth:1.75,apply:()=>{gpc+=5},lvl:0}];
const autoShopData=[{name:"Gants véloces (CPS)",base:60,growth:1.7,add:1,lvl:0},
                    {name:"Totem frénétique (CPS)",base:520,growth:1.7,add:5,lvl:0},
                    {name:"Dragonnet (DPS)",base:6000,growth:1.65,addDPS:60,lvl:0}];
const dodgeShopData=[{name:"+1% Esquive auto",base:800,growth:1.5,add:1,lvl:0}];
const soldiers=[{rank:"E",name:"Éclaireur",base:120,growth:1.6,dps:4,owned:0},
                {rank:"D",name:"Archer elfe",base:460,growth:1.6,dps:18,owned:0},
                {rank:"C",name:"Guerrier orc",base:1900,growth:1.6,dps:90,owned:0},
                {rank:"B",name:"Mage azur",base:8200,growth:1.6,dps:420,owned:0},
                {rank:"A",name:"Chevalier runique",base:38000,growth:1.6,dps:2100,owned:0},
                {rank:"S",name:"Dragon noir",base:160000,growth:1.6,dps:9800,owned:0}];

const gemHeroes=[
 {rank:"SS", name:"Seigneur Orque", img:"https://images.unsplash.com/photo-1545444221-3ca4b3e6b9a6?auto=format&fit=crop&w=200&q=60", costBase:10000, growth:2.0, baseDps:260000, owned:0, lvl:0, xp:0, xpNext:140, perk:"gold"},
 {rank:"SS", name:"Démoniste Écarlate", img:"https://images.unsplash.com/photo-1549880338-8f9b9f4bdec0?auto=format&fit=crop&w=200&q=60", costBase:20000, growth:2.0, baseDps:360000, owned:0, lvl:0, xp:0, xpNext:140, perk:"regen"},
 {rank:"SSS",name:"Dragon Empyréen", img:"https://images.unsplash.com/photo-1549880338-65ddcdfd017b?auto=format&fit=crop&w=200&q=60", costBase:40000, growth:2.0, baseDps:1200000, owned:0, lvl:0, xp:0, xpNext:160, perk:"dps"},
 {rank:"SSS",name:"Oracle des Abysses", img:"https://images.unsplash.com/photo-1620070234772-4b8af5120a28?auto=format&fit=crop&w=200&q=60", costBase:80000, growth:2.0, baseDps:1800000, owned:0, lvl:0, xp:0, xpNext:160, perk:"crit"}
];
const GEM_UPGRADES=[{key:"gCritR",name:"+1% Taux Crit",icon:"⭐",costBase:120,growth:1.7,lvl:0},
                    {key:"gCritM",name:"+0,1× Dégâts Crit",icon:"💥",costBase:160,growth:1.72,lvl:0},
                    {key:"gGpc",name:"+5 Or/clic",icon:"🖱️",costBase:110,growth:1.7,lvl:0},
                    {key:"gRegen",name:"+0,5 PV/s",icon:"➕",costBase:120,growth:1.68,lvl:0},
                    {key:"gVital",name:"+100 PV Max",icon:"❤️",costBase:190,growth:1.7,lvl:0},
                    {key:"gDodge",name:"+1% Esquive",icon:"🛡️",costBase:150,growth:1.68,lvl:0},
                    {key:"gDps",name:"+5% DPS",icon:"⚔️",costBase:220,growth:1.75,lvl:0}];
const PRESTIGE=[{key:"gold",name:"+10% Or",base:3,growth:1.6,inc:.10,lvl:0},
                {key:"power",name:"+10% DPS",base:3,growth:1.6,inc:.10,lvl:0},
                {key:"regen",name:"+0,5 PV/s",base:2,growth:1.5,inc:.5,lvl:0},
                {key:"vital",name:"+100 PV",base:2,growth:1.5,inc:100,lvl:0},
                {key:"click",name:"+1 Or/clic",base:2,growth:1.7,inc:1,lvl:0},
                {key:"attack",name:"+1 Attaque base",base:2,growth:1.7,inc:1,lvl:0},
                {key:"critR",name:"+2% Crit",base:3,growth:1.7,inc:2,lvl:0},
                {key:"critM",name:"+0,2× Crit",base:3,growth:1.75,inc:.2,lvl:0}];
const DUNGEONS=[{key:"D1",name:"Caveau gobelin",reqWave:1,xp:35,gemChance:.06,cooldown:5000,last:0},
                {key:"D2",name:"Cratère orc",reqWave:12,xp:90,gemChance:.08,cooldown:5500,last:0},
                {key:"D3",name:"Faille démon",reqWave:28,xp:210,gemChance:.12,cooldown:6000,last:0},
                {key:"D4",name:"Sanctuaire drake",reqWave:52,xp:460,gemChance:.16,cooldown:6500,last:0}];
const QUESTS=[{key:"q_clicks",name:"Cliquer 100 fois",type:"clicks",target:100,reward:60,done:false,claimed:false},
              {key:"q_kills",name:"Vaincre 50 ennemis",type:"kills",target:50,reward:90,done:false,claimed:false},
              {key:"q_wave",name:"Atteindre la vague 25",type:"wave",target:25,reward:140,done:false,claimed:false},
              {key:"q_hero",name:"Recruter 1 héros 💎",type:"hero",target:1,reward:200,done:false,claimed:false}];

// --- helpers UI
function applyBiome(){
  const idx=Math.floor((wave-1)/10)%3;
  const style=document.documentElement.style;
  if(idx===0){ biomeBg.style.background="linear-gradient(180deg,rgba(34,139,76,.22),rgba(10,16,38,.6)),linear-gradient(160deg,#0f1c3f,#091233)"; style.setProperty("--after-url","url('https://images.unsplash.com/photo-1470770903676-69b98201ea1c?auto=format&fit=crop&w=1200&q=60')"); }
  else if(idx===1){ biomeBg.style.background="linear-gradient(180deg,rgba(200,240,255,.16),rgba(10,16,38,.6)),linear-gradient(160deg,#0e234d,#0a1436)"; style.setProperty("--after-url","url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1200&q=60')"); }
  else { biomeBg.style.background="linear-gradient(180deg,rgba(255,120,80,.18),rgba(10,16,38,.6)),linear-gradient(160deg,#1b0f2f,#120a24)"; style.setProperty("--after-url","url('https://images.unsplash.com/photo-1499696010180-025ef6e1a8f9?auto=format&fit=crop&w=1200&q=60')"); }
}
function pickEnemy(){ return (wave%10===0)? bosses[Math.floor(((wave/10)-1)%bosses.length)] : enemies[(wave-1)%enemies.length]; }
function updateBars(){ $("hpNow").textContent=fmt(hpNow); $("hpMax").textContent=fmt(hpMax); hpFill.style.width=Math.max(0,Math.min(100,hpNow/hpMax*100))+"%"; $("phpNow").textContent=fmt(phpNow); $("phpMax").textContent=fmt(phpMax); phpFill.style.width=Math.max(0,Math.min(100,phpNow/phpMax*100))+"%"; }
function updateTop(){ $("waveTop").textContent=wave; $("wave").textContent=wave; goldEl.textContent=fmt(gold); gemsEl.textContent=fmt(gems); starsEl.textContent=fmt(stars); $("gpc").textContent=fmt(gpc); $("dps").textContent=fmt(dps); $("critRate").textContent=Math.min(100,critRate).toFixed(0); $("critMult").textContent=critMult.toFixed(2); $("dodge").textContent=Math.min(40,dodgePct).toFixed(0); $("regen").textContent=regenPerSec.toFixed(1); $("reward").textContent="+"+fmt(Math.round(rewardForWave(wave)))+((wave%10===0)?" (boss)":""); }
function setEnemy(){ const meta=pickEnemy(); enemyImg.src=meta.img; enemyNameEl.textContent=meta.name; $("bossTag").textContent=(wave%10===0)?"BOSS":""; }

// --- combat
function newWave(){ const sc=scaleForWave(wave); hpMax=sc.hp; hpNow=hpMax; applyBiome(); setEnemy(); updateBars(); updateTop(); }
function float(txt,x,y,color){ const d=document.createElement("div"); d.className="float"; d.textContent=txt; d.style.left=x+"px"; d.style.top=y+"px"; d.style.color=color||"white"; document.body.appendChild(d); setTimeout(()=>d.remove(),900); }
function projectile(x,y,tx,ty,style){ const p=document.createElement("div"); p.style.position="fixed"; p.style.left=x+"px"; p.style.top=y+"px"; p.style.width="14px"; p.style.height="14px"; p.style.borderRadius="50%"; p.style.zIndex="998"; p.style.background=style==="enemy"?"radial-gradient(circle,#fff5cc,#ff9a5e,#ff6a3d)":"linear-gradient(180deg,#7fffd4,#b8ffe9)"; p.animate([{transform:"translate(0,0)",opacity:1},{transform:`translate(${tx-x}px,${ty-y}px)`,opacity:.25}],{duration:360,easing:"cubic-bezier(.2,.8,.2,1)"}); document.body.appendChild(p); setTimeout(()=>p.remove(),380); }
function doDamage(base,rect){ let dmg=base; const isCrit=Math.random()*100<critRate; if(isCrit) dmg=Math.ceil(dmg*critMult); hpNow=Math.max(0,hpNow-dmg); float(isCrit?("-"+dmg+" ★"):("-"+dmg),rect.left+rect.width/2,rect.top+10,isCrit?"#ffe887":"#ff9aa6"); }
function killCheck(rect){ if(hpNow>0) return; totalKills++; const r=rewardForWave(wave); gold+=r; float("+"+r+" ⛃",rect.left+rect.width/2,rect.top+rect.height/2,"#ffd66b"); if(wave%10===0){ const drop=R(30,100); gems+=drop; float("+"+drop+" 💎",rect.left+rect.width/2,rect.top+6,"#79f2ff"); } wave++; newWave(); save(); }
function clickHit(){ if(hpNow<=0) return; totalClicks++; const rect=enemyImg.getBoundingClientRect(); projectile(rect.left+rect.width/2,rect.top+rect.height/2,rect.left+rect.width/2+40,rect.top+rect.height/2-6,"ally"); doDamage(atkBase,rect); const goldMult=1+PRESTIGE.find(p=>p.key==="gold").lvl*.10; gold+=Math.max(1,Math.floor(gpc*goldMult)); updateBars(); killCheck(rect); updateTop(); save(); }
function enemyAttack(){ if(hpNow<=0) return; const er=enemyImg.getBoundingClientRect(); const tx=innerWidth-60,ty=84; setTimeout(()=>{ projectile(er.left+er.width/2,er.top+er.height/2,tx,ty,"enemy"); setTimeout(()=>{ if(Math.random()*100<dodgePct){ float("ÉVITÉ !",innerWidth-80,72,"#7fffd4"); return;} const dmg=enemyDamage(); phpNow=Math.max(0,phpNow-dmg); updateBars(); float("-"+dmg,innerWidth-80,74,"#ff8a8a"); if(phpNow===0){ onDeath(); } },340); },360); }

// --- ascension
function computeStars(){ const bosses=Math.floor((wave-1)/10); return Math.max(1,Math.floor(wave/4)+bosses*2); }
function onDeath(){ stars+=computeStars(); // conserve gems/héros/upgrades gem
  wave=1; gold=0;
  // reset or-shops
  clickShopData.forEach(u=>u.lvl=0); autoShopData.forEach(u=>u.lvl=0); dodgeShopData.forEach(u=>u.lvl=0); soldiers.forEach(s=>s.owned=0);
  recalc(); phpNow=phpMax; const sc=scaleForWave(wave); hpMax=sc.hp; hpNow=hpMax; newWave(); buildAll(); updateBars(); updateTop(); save(); }

// --- héros gem / perks
function heroCost(h){return Math.floor(h.costBase*Math.pow(h.growth,h.owned));}
function heroDps(h){return h.owned>0?Math.floor(h.baseDps*(1+0.25*h.lvl))*h.owned:0;}
function heroPerkTiers(h){return Math.floor(h.lvl/10);}
function totalHeroDps(){return gemHeroes.reduce((s,h)=>s+heroDps(h),0);}

// --- recalculs globaux
function gemLvl(key){const u=GEM_UPGRADES.find(x=>x.key===key); return u?u.lvl:0;}
function recalc(){
  autoClicks=autoShopData.reduce((s,u)=>s+(u.add||0)*(u.lvl||0),0);
  let addDPS=autoShopData.reduce((s,u)=>s+(u.addDPS||0)*(u.lvl||0),0)+soldiers.reduce((s,o)=>s+o.dps*(o.owned||0),0)+totalHeroDps();
  let perkGold=0,perkDps=0,perkCritR=0,perkRegen=0,perkVital=0;
  gemHeroes.forEach(h=>{const t=heroPerkTiers(h); if(t<=0)return; if(h.perk==="gold")perkGold+=0.05*t; if(h.perk==="dps")perkDps+=0.08*t; if(h.perk==="crit")perkCritR+=1*t; if(h.perk==="regen")perkRegen+=0.2*t; if(Math.floor(h.lvl/20)>0) perkVital+=50*Math.floor(h.lvl/20);});
  const powMult=(1+PRESTIGE.find(p=>p.key==="power").lvl*.10)*(1+gemLvl("gDps")*.05)*(1+perkDps);
  dps=Math.floor(addDPS*powMult);
  const clickBase=1+PRESTIGE.find(p=>p.key==="click").lvl*1+gemLvl("gGpc")*5;
  const clickShopAdd=clickShopData.reduce((s,u)=>s+(u.lvl||0)*(u.add?u.add:0),0);
  gpc=Math.floor((clickBase+clickShopAdd)*(1+perkGold));
  regenPerSec=1.0+PRESTIGE.find(p=>p.key==="regen").lvl*.5+gemLvl("gRegen")*.5+perkRegen;
  atkBase=1+PRESTIGE.find(p=>p.key==="attack").lvl;
  critRate=PRESTIGE.find(p=>p.key==="critR").lvl*2+gemLvl("gCritR")*1+perkCritR;
  critMult=(1.5+PRESTIGE.find(p=>p.key==="critM").lvl*.2)+gemLvl("gCritM")*.1;
  dodgePct=Math.min(40,5+(dodgeShopData[0].lvl||0)*1+gemLvl("gDodge")*1);
  phpMax=100+PRESTIGE.find(p=>p.key==="vital").lvl*100+gemLvl("gVital")*100+perkVital;
  if(phpNow>phpMax) phpNow=phpMax;
}

// --- float helpers
function bulkCost(base,growth,lvl,qty){ if(qty<=0) return 0; const start=base*Math.pow(growth,lvl); return Math.floor(start*(Math.pow(growth,qty)-1)/(growth-1)); }
function nextCost(base,growth,lvl){return Math.floor(base*Math.pow(growth,lvl));}
function maxAffordable(base,growth,lvl,bank){ let lo=0,hi=1; while(bulkCost(base,growth,lvl,hi)<=bank){lo=hi;hi*=2;if(hi>1e6)break;} while(lo<hi){ const mid=Math.ceil((lo+hi)/2); if(bulkCost(base,growth,lvl,mid)<=bank){lo=mid;} else hi=mid-1; } return lo; }

// --- UIs
const clickShopDiv=$("clickShop"),autoShopDiv=$("autoShop"),soldierShopDiv=$("soldierShop"),dodgeShopDiv=$("dodgeShop"),gemShopDiv=$("gemShop"),gemUpgShopDiv=$("gemUpgShop"),prestigeShopDiv=$("prestigeShop"),dungeonGrid=$("dungeonGrid"),questGrid=$("questGrid");

function buildClickShop(){ clickShopDiv.innerHTML=""; clickShopData.forEach(u=>{ const total=bulkCost(u.base,u.growth,u.lvl,buyQty),unit=nextCost(u.base,u.growth,u.lvl); const row=document.createElement("div"); row.className="item gold"; row.innerHTML=`<div class="ico">🖱</div><div class="grow"><div><b>${u.name}</b></div><small>Niv ${u.lvl} • Unité ${fmt(unit)} • x${buyQty} ${fmt(total)}</small></div>`; const btn=document.createElement("button"); btn.className="btn gold"; btn.textContent=fmt(total)+" ⛃"; btn.onclick=()=>{ const m=maxAffordable(u.base,u.growth,u.lvl,gold); if(m<=0)return; const q=Math.min(buyQty,m); gold-=bulkCost(u.base,u.growth,u.lvl,q); u.lvl+=q; for(let i=0;i<q;i++) u.apply(); recalc(); updateTop(); buildClickShop(); save(); }; row.appendChild(btn); clickShopDiv.appendChild(row); }); }
function buildAutoShop(){ autoShopDiv.innerHTML=""; autoShopData.forEach(u=>{ const total=bulkCost(u.base,u.growth,u.lvl||0,buyQty),unit=nextCost(u.base,u.growth,u.lvl||0); const row=document.createElement("div"); row.className="item gold"; const desc=(u.add?`+${u.add} CPS/niv`:`+${u.addDPS||0} DPS/niv`); row.innerHTML=`<div class="ico">⚙️</div><div class="grow"><div><b>${u.name}</b></div><small>Lvl ${u.lvl||0} • ${desc} • Unité ${fmt(unit)} • x${buyQty} ${fmt(total)}</small></div>`; const btn=document.createElement("button"); btn.className="btn gold"; btn.textContent=fmt(total)+" ⛃"; btn.onclick=()=>{ const m=maxAffordable(u.base,u.growth,u.lvl||0,gold); if(m<=0)return; const q=Math.min(buyQty,m); gold-=bulkCost(u.base,u.growth,u.lvl||0,q); u.lvl=(u.lvl||0)+q; recalc(); updateTop(); buildAutoShop(); save(); }; row.appendChild(btn); autoShopDiv.appendChild(row); }); }
function buildDodgeShop(){ dodgeShopDiv.innerHTML=""; dodgeShopData.forEach(u=>{ const total=bulkCost(u.base,u.growth,u.lvl||0,buyQty),unit=nextCost(u.base,u.growth,u.lvl||0); const row=document.createElement("div"); row.className="item gold"; row.innerHTML=`<div class="ico">🛡️</div><div class="grow"><div><b>${u.name}</b></div><small>Lvl ${u.lvl||0} • +${u.add}%/niv • Unité ${fmt(unit)} • x${buyQty} ${fmt(total)}</small></div>`; const btn=document.createElement("button"); btn.className="btn gold"; btn.textContent=fmt(total)+" ⛃"; btn.onclick=()=>{ const m=maxAffordable(u.base,u.growth,u.lvl||0,gold); if(m<=0)return; const q=Math.min(buyQty,m); gold-=bulkCost(u.base,u.growth,u.lvl||0,q); u.lvl=(u.lvl||0)+q; dodgePct=Math.min(40,dodgePct+u.add*q); updateTop(); buildDodgeShop(); save(); }; row.appendChild(btn); dodgeShopDiv.appendChild(row); }); }
function buildSoldierShop(){ soldierShopDiv.innerHTML=""; soldiers.forEach(s=>{ const total=bulkCost(s.base,s.growth,s.owned,buyQty),unit=nextCost(s.base,s.growth,s.owned); const row=document.createElement("div"); row.className="item gold"; row.innerHTML=`<div class="ico">🎖️</div><div class="grow"><div><span style="font-weight:900">Rang ${s.rank}</span> — ${s.name}</div><small>Possédés ${s.owned} • DPS/u ${fmt(s.dps)} • Unité ${fmt(unit)} • x${buyQty} ${fmt(total)}</small></div>`; const btn=document.createElement("button"); btn.className="btn gold"; btn.textContent=fmt(total)+" ⛃"; btn.onclick=()=>{ const m=maxAffordable(s.base,s.growth,s.owned,gold); if(m<=0)return; const q=Math.min(buyQty,m); gold-=bulkCost(s.base,s.growth,s.owned,q); s.owned+=q; recalc(); updateTop(); buildSoldierShop(); save(); }; row.appendChild(btn); soldierShopDiv.appendChild(row); }); }

function gemUpgCost(u){ return Math.floor(u.costBase*Math.pow(u.growth,u.lvl)); }
function buildGemUpgShop(){ gemUpgShopDiv.innerHTML=""; GEM_UPGRADES.forEach(u=>{ const cost=gemUpgCost(u); const row=document.createElement("div"); row.className="item gem"; row.innerHTML=`<div class="ico">${u.icon}</div><div class="grow"><div><b>${u.name}</b></div><small>Niv ${u.lvl} • Coût ${cost} 💎</small></div>`; const btn=document.createElement("button"); btn.className="btn gem"; btn.textContent=fmt(cost)+" 💎"; btn.onclick=()=>{ if(gems<cost)return; gems-=cost; u.lvl++; recalc(); updateBars(); updateTop(); buildGemUpgShop(); save(); }; row.appendChild(btn); gemUpgShopDiv.appendChild(row); }); }
function perkDesc(h){ const t=Math.floor(h.lvl/10); if(t<=0)return ""; if(h.perk==="gold")return ` • +${t*5}% or`; if(h.perk==="dps")return ` • +${t*8}% DPS`; if(h.perk==="crit")return ` • +${t}% crit`; if(h.perk==="regen")return ` • +${(t*0.2).toFixed(1)} PV/s`; return ""; }
function buildGemShop(){ gemShopDiv.innerHTML=""; gemHeroes.forEach(h=>{ const cost=heroCost(h); const row=document.createElement("div"); row.className="item gem"; row.innerHTML=`<img class="heroPic" src="${h.img}"><div class="grow"><div><span style="font-weight:900">Rang ${h.rank}</span> — ${h.name}</div><small>Possédés ${h.owned} • DPS ${fmt(h.owned?Math.floor(h.baseDps*(1+0.25*h.lvl))*h.owned:h.baseDps)} • Lvl ${h.lvl} (${h.xp}/${h.xpNext})${perkDesc(h)}</small></div>`; const btn=document.createElement("button"); btn.className="btn gem"; btn.textContent=fmt(cost)+" 💎"; btn.onclick=()=>{ if(gems<cost)return; gems-=cost; h.owned++; recalc(); updateTop(); buildGemShop(); updateQuestsProgress(); save(); }; row.appendChild(btn); gemShopDiv.appendChild(row); }); }
function buildPrestigeShop(){ prestigeShopDiv.innerHTML=""; PRESTIGE.forEach(p=>{ const cost=Math.floor(p.base*Math.pow(p.growth,p.lvl)); const row=document.createElement("div"); row.className="item star"; row.innerHTML=`<div class="ico">⭐</div><div class="grow"><div><b>${p.name}</b></div><small>Niv ${p.lvl} • Coût ${cost} ⭐</small></div>`; const btn=document.createElement("button"); btn.className="btn star"; btn.textContent=`${cost} ⭐`; btn.onclick=()=>{ if(stars<cost)return; stars-=cost; p.lvl++; recalc(); updateBars(); updateTop(); buildPrestigeShop(); save(); }; row.appendChild(btn); prestigeShopDiv.appendChild(row); }); }
function buildDungeon(){ dungeonGrid.innerHTML=""; DUNGEONS.forEach(d=>{ const ready=Date.now()-d.last>=d.cooldown; const row=document.createElement("div"); row.className="item"; row.innerHTML=`<div class="ico">🏰</div><div class="grow"><div><b>${d.name}</b> — req vague ${d.reqWave}</div><small>Gain ${d.xp} XP • Gemmes ${(d.gemChance*100).toFixed(0)}% • CD ${(d.cooldown/1000).toFixed(1)}s${ready?"":" • ⏳"}</small></div>`; const btn=document.createElement("button"); btn.className="btn gem"; btn.textContent=ready?"Lancer":"⏳"; btn.disabled=!ready||wave<d.reqWave; btn.onclick=()=>{ if(btn.disabled)return; d.last=Date.now(); giveHeroXp(d.xp); if(Math.random()<d.gemChance){ const bonus=R(10,30); gems+=bonus; updateTop(); float("+"+bonus+" 💎 (Donjon)",innerWidth/2,120,"#79f2ff");} buildDungeon(); save(); }; row.appendChild(btn); dungeonGrid.appendChild(row); }); }
function updateQuestsProgress(){ QUESTS.forEach(q=>{ if(q.done)return; if(q.type==="clicks"&&totalClicks>=q.target)q.done=true; if(q.type==="kills"&&totalKills>=q.target)q.done=true; if(q.type==="wave"&&wave>=q.target)q.done=true; if(q.type==="hero"&&gemHeroes.some(h=>h.owned>0))q.done=true; }); buildQuests(); }
function buildQuests(){ questGrid.innerHTML=""; QUESTS.forEach(q=>{ const row=document.createElement("div"); row.className="item"; const progress=(q.type==="clicks")?Math.min(totalClicks,q.target):(q.type==="kills")?Math.min(totalKills,q.target):(q.type==="wave")?Math.min(wave-1,q.target):(q.type==="hero")?(gemHeroes.some(h=>h.owned>0)?q.target:0):0; row.innerHTML=`<div class="ico">📜</div><div class="grow"><div><b>${q.name}</b></div><small>Progression ${progress}/${q.target} • Récompense ${q.reward} 💎</small></div>`; const btn=document.createElement("button"); btn.className="btn gem"; btn.textContent=q.claimed?"Réclamée":(q.done?"Réclamer":"En cours"); btn.disabled=!q.done||q.claimed; btn.onclick=()=>{ if(q.done&&!q.claimed){ q.claimed=true; gems+=q.reward; updateTop(); float("+"+q.reward+" 💎 (Quête)",innerWidth/2,140,"#79f2ff"); buildQuests(); save(); } }; row.appendChild(btn); questGrid.appendChild(row); }); }

function buildAll(){ buildClickShop(); buildAutoShop(); buildDodgeShop(); buildSoldierShop(); buildGemShop(); buildGemUpgShop(); buildPrestigeShop(); buildDungeon(); buildQuests(); }

// --- progression héros
function giveHeroXp(amount){ const owned=gemHeroes.filter(h=>h.owned>0); if(!owned.length) return; const per=Math.max(1,Math.floor(amount/owned.length)); owned.forEach(h=>{ let tier=heroPerkTiers(h); h.xp+=per; while(h.xp>=h.xpNext){ h.xp-=h.xpNext; h.lvl++; h.xpNext=Math.floor(h.xpNext*1.4+10); const t2=heroPerkTiers(h); if(t2>tier){ float(`✨ Perk ${h.name}`, innerWidth/2, 120, "#ffe887"); tier=t2; }}}); recalc(); updateTop(); buildGemShop(); buildQuests(); }

// --- sauvegarde
function save(){ try{ localStorage.setItem("ch:save:full",JSON.stringify({gold,gems,stars,wave,phpMax,phpNow,gpc,dps,autoClicks,dodgePct,atkBase,critRate,critMult,regenPerSec,clickShopData,autoShopData,dodgeShopData,soldiers,gemHeroes,GEM_UPGRADES,PRESTIGE,DUNGEONS,QUESTS,last:Date.now()})); }catch(e){} }
function load(){ try{ const raw=localStorage.getItem("ch:save:full"); if(!raw) return; const d=JSON.parse(raw); Object.assign(window,{gold:0},d); ["clickShopData","autoShopData","dodgeShopData"].forEach(k=>d[k]&&d[k].forEach((u,i)=>{ if(window[k][i]) window[k][i].lvl=u.lvl; })); soldiers.forEach((s,i)=>{ if(d.soldiers&&d.soldiers[i]) s.owned=d.soldiers[i].owned; }); if(d.gemHeroes) d.gemHeroes.forEach((h,i)=>{ if(gemHeroes[i]) Object.assign(gemHeroes[i],{owned:h.owned,lvl:h.lvl,xp:h.xp,xpNext:h.xpNext}); }); if(d.GEM_UPGRADES) d.GEM_UPGRADES.forEach((u,i)=>{ if(GEM_UPGRADES[i]) GEM_UPGRADES[i].lvl=u.lvl; }); if(d.PRESTIGE) d.PRESTIGE.forEach((p,i)=>{ if(PRESTIGE[i]) PRESTIGE[i].lvl=p.lvl; }); }catch(e){} }

// --- listeners
document.querySelectorAll(".navInner button[data-goto]").forEach(b=>b.addEventListener("click",()=>{ document.querySelectorAll(".navInner button").forEach(x=>x.classList.remove("active")); b.classList.add("active"); const goto=b.getAttribute("data-goto"); document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active",t.getAttribute("data-tab")===goto)); window.scrollTo({top:0,behavior:"smooth"}); }));
document.querySelectorAll("[data-q]").forEach(b=>b.addEventListener("click",()=>{ document.querySelectorAll("[data-q]").forEach(x=>x.classList.remove("active")); b.classList.add("active"); buyQty=parseInt(b.getAttribute("data-q"),10)||1; }));
$("hitBtn").onclick=$("hitZone").onclick=$("enemyImg").onclick=clickHit;
$("saveBtn").onclick=()=>{ save(); float("Sauvegardé ✔",innerWidth/2,70,"#b8ffe9"); };
$("resetBtn").onclick=()=>{ if(confirm("Ascension maintenant ?")) onDeath(); };

// --- init
(function start(){ applyBiome(); setEnemy(); const sc=scaleForWave(wave); hpMax=sc.hp; hpNow=hpMax; recalc(); buildAll(); updateBars(); updateTop(); load(); recalc(); updateBars(); updateTop(); buildAll(); })();

// --- ticks
setInterval(()=>{ const per=dps/10; if(per<=0||hpNow<=0) return; const rect=enemyImg.getBoundingClientRect(); let dmg=Math.max(1,Math.floor(per)); if(Math.random()*100<critRate) dmg=Math.ceil(dmg*critMult); hpNow=Math.max(0,hpNow-dmg); float("-"+fmt(dmg),rect.left+rect.width/2+12,rect.top+18,"#ffdf7a"); updateBars(); killCheck(rect); },100);
setInterval(()=>{ if(autoClicks<=0||hpNow<=0) return; const rect=enemyImg.getBoundingClientRect(); const per=autoClicks/4; const n=Math.floor(per)+(Math.random()<(per-Math.floor(per))?1:0); const goldMult=1+PRESTIGE.find(p=>p.key==="gold").lvl*.10; for(let i=0;i<n;i++){ doDamage(atkBase,rect); projectile(rect.left+rect.width/2,rect.top+rect.height/2,rect.left+rect.width/2+20,rect.top+rect.height/2-4,"ally"); gold+=Math.max(1,Math.floor(gpc*goldMult)); } updateBars(); killCheck(rect); updateTop(); },250);
setInterval(()=>{ if(Math.random()<0.65) enemyAttack(); },1200);
setInterval(()=>{ if(regenPerSec>0 && phpNow>0 && phpNow<phpMax){ const heal=Math.min(regenPerSec,phpMax-phpNow); phpNow+=heal; updateBars(); } },1000);
setInterval(()=>{ updateQuestsProgress(); },800);
setInterval(save,30000); window.addEventListener("beforeunload",save);
})();</script>

<!-- Enregistrement SW -->
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(console.error));
}
</script>
</body>
</html>
